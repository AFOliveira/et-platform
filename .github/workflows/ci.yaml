name: CI
on:
  push:
    branches:
      - "master"
      - "main"
  pull_request:
    branches:
      - "master"
      - "main"

  workflow_dispatch:

jobs:
  build:
    name: Build
    strategy:
      matrix:
        target:
          # add more targets to build for more
          - distro_name: ubuntu
            distro_version: 24.04

    runs-on: ubuntu-latest
    steps:

    - name: Check out code
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: build in docker
      uses: docker/build-push-action@v6
      with:
        context: .  # this is necessary for .git to be available inside the container
        push: false
        file: docker/Dockerfile
        tags: et-platform:latest
        build-args: |
          BASE_DISTRO=${{ matrix.target.distro_name }}
          DISTRO_VERSION=${{ matrix.target.distro_version }}
          VERBOSE=1
          GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
        outputs: type=docker,dest=${{ runner.temp }}/platform.tar
    - name: Upload build image
      uses: actions/upload-artifact@v4
      with:
        name: platform
        path: ${{ runner.temp }}/platform.tar

  test:
    name: Test
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: platform
          path: ${{ runner.temp }}
      - name: Load image
        run: |
          docker load --input ${{ runner.temp }}/platform.tar
          # run `docker image ls`, just to see that it is there
          docker image ls
      - name: Run integration tests
        id: integration
        continue-on-error: true
        run: |
          docker run --rm -w /out -v ${{ runner.temp }}/out:/out et-platform:latest /bin/bash -c "/opt/et/bin/it_test_code_loading"
      - name: Run Erbium emulator tests
        id: erbium
        continue-on-error: true
        run: |
          docker run --rm et-platform:latest /bin/bash -c "make -C /workspace/sw-sysemu/tests/erbium run RISCV=/opt/et/bin EMU=/opt/et/bin/erbium_emu"
      - name: Run Erbium GDB tests
        id: gdb
        continue-on-error: true
        run: |
          docker run --rm et-platform:latest /bin/bash -c "make -C /workspace/sw-sysemu/tests/erbium run-gdb RISCV=/opt/et/bin EMU=/opt/et/bin/erbium_emu"
      - name: Run ET-SOC1 debug tests
        id: debug
        continue-on-error: true
        run: |
          docker run --rm et-platform:latest /bin/bash -c "export PATH=/opt/et/bin:\$PATH && make -C /workspace/sw-sysemu/debug_tests && make -C /workspace/sw-sysemu/debug_tests run SYSEMU=/opt/et/bin/sys_emu"
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: ${{ runner.temp }}/out
          if-no-files-found: warn
      - name: Report test results
        if: always()
        run: |
          for file in ${{ runner.temp }}/out/*.log*; do
            echo "===== Test result: $file ====="
            cat "$file"
            echo "================================"
          done
      - name: Check test results
        if: always()
        run: |
          if [[ "${{ steps.integration.outcome }}" == "failure" || \
                "${{ steps.erbium.outcome }}" == "failure" || \
                "${{ steps.gdb.outcome }}" == "failure" || \
                "${{ steps.debug.outcome }}" == "failure" ]]; then
            echo "One or more test suites failed"
            exit 1
          fi
